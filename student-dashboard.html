<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard - Python Test Platform</title>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        body {
            background: var(--bg-primary);
        }
        
        .dashboard-header {
            animation: slideDown 0.4s ease-out;
        }
        
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .dashboard-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: var(--space-8);
            display: flex;
            flex-direction: column;
            gap: var(--space-10);
        }
        
        .profile-section,
        .tests-section,
        .history-section,
        .section {
            width: 100%;
            animation: fadeIn 0.6s ease-out;
            animation-fill-mode: both;
        }
        
        .profile-section { animation-delay: 0.1s; }
        .tests-section { animation-delay: 0.2s; }
        .history-section { animation-delay: 0.3s; }
        
        .profile-section h2,
        .tests-section h2,
        .history-section h2 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: var(--space-6);
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .profile-section h2::before {
            content: 'üë§';
            font-size: 1.75rem;
        }
        
        .tests-section h2::before {
            content: 'üìù';
            font-size: 1.75rem;
        }
        
        .history-section h2::before {
            content: 'üìä';
            font-size: 1.75rem;
        }
        
        .section-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-xl);
            padding: var(--space-6);
            box-shadow: var(--shadow-sm);
        }
        
        .profile-grid {
            display: flex;
            flex-direction: column;
            gap: var(--space-6);
        }
        
        .profile-item {
            background: linear-gradient(135deg, var(--bg-tertiary) 0%, var(--bg-secondary) 100%);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-lg);
            padding: var(--space-5);
            transition: all 0.3s;
        }
        
        .profile-item:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-md);
            border-color: var(--accent);
        }
        
        .profile-item strong {
            display: block;
            color: var(--text-secondary);
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }
        
        .profile-item span {
            color: var(--text-primary);
            font-size: 1.125rem;
            font-weight: 500;
        }
        
        .tests-grid {
            display: flex;
            flex-direction: column;
            gap: var(--space-6);
        }
        
        @media (max-width: 768px) {
            .tests-grid {
                flex-direction: column;
            }
            .profile-grid {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <header class="dashboard-header">
        <h1>Student Dashboard</h1>
        <div class="user-info">
            <span id="user-name" style="font-weight: 500; color: var(--text-secondary);"></span>
            <button onclick="logout()" class="btn btn-secondary btn-sm">Logout</button>
        </div>
    </header>
    
    <main class="dashboard-content">
        <section class="profile-section">
            <h2>Your Profile</h2>
            <div id="profile-details" class="profile-grid"></div>
        </section>
        
        <section class="tests-section">
            <h2>Available Tests</h2>
            <div id="available-tests" class="tests-grid">
                <div class="empty-state">
                    <div class="empty-state-icon">üìù</div>
                    <div class="empty-state-text">Loading tests...</div>
                </div>
            </div>
        </section>
        
        <!-- Test History Section -->
        <section class="history-section">
            <h2>Test History</h2>
            <div id="test-history">
                <div class="empty-state">
                    <div class="empty-state-icon">üìä</div>
                    <div class="empty-state-text">Loading history...</div>
                </div>
            </div>
        </section>
    </main>
    
    <!-- Load questions data -->
    <script src="data/questions.js"></script>
    
    <script type="module">
        import { onAuthStateChanged, signOut, isDemoUser, getDemoUser } from './js/firebase-auth.js';
        import { getAllTests, getTestAttemptsByUser, checkUserHasAttemptedTest } from './js/firebase-database.js';
        
        let currentUser = null;
        
        async function initStudentDashboard() {
            // Initialize test questions if available
            if (typeof initializeTestQuestions === 'function') {
                initializeTestQuestions();
            }
            
            // Check for demo user
            if (isDemoUser()) {
                currentUser = getDemoUser();
                
                // Prevent admin from accessing student dashboard
                if (currentUser.role === 'admin') {
                    alert('Admins cannot access student dashboard. Redirecting to admin panel.');
                    window.location.href = 'admin-dashboard.html';
                    return;
                }
                
                displayUserInfo();
                await loadData();
                return;
            }
            
            // Check Firebase auth
            onAuthStateChanged(async (user) => {
                if (!user) {
                    console.log('No Firebase user, redirecting to login');
                    window.location.href = 'login.html';
                    return;
                }
                
                // Get user data from session or Firestore
                const userJson = sessionStorage.getItem('currentUser');
                if (userJson) {
                    currentUser = JSON.parse(userJson);
                    console.log('Current user from session:', currentUser);
                } else {
                    console.log('No user in session, redirecting to login');
                    window.location.href = 'login.html';
                    return;
                }
                
                // Prevent admin from accessing student dashboard
                if (currentUser.role === 'admin') {
                    console.log('Admin user detected, redirecting to admin panel');
                    alert('Admins cannot access student dashboard. Redirecting to admin panel.');
                    window.location.href = 'admin-dashboard.html';
                    return;
                }
                
                displayUserInfo();
                await loadData();
            });
        }
        
        function displayUserInfo() {
            document.getElementById('user-name').textContent = currentUser.name;
            document.getElementById('profile-details').innerHTML = `
                <div class=\"profile-item\">
                    <strong>Full Name</strong>
                    <span>${currentUser.name}</span>
                </div>
                <div class=\"profile-item\">
                    <strong>Email Address</strong>
                    <span>${currentUser.email}</span>
                </div>
                <div class=\"profile-item\">
                    <strong>Department</strong>
                    <span>${currentUser.department || 'Not Set'}</span>
                </div>
                <div class=\"profile-item\">
                    <strong>WhatsApp</strong>
                    <span>${currentUser.whatsapp || 'Not Set'}</span>
                </div>
            `;
        }
        
        async function loadData() {
            await loadAvailableTests();
            await loadTestHistory();
            updateStatistics();
        }
        
        function updateStatistics() {
            // Get all test cards
            const allTests = document.querySelectorAll('.test-card').length;
            const availableTests = document.querySelectorAll('.test-card:not(.disabled)').length;
            
            // Update available tests count
            document.getElementById('stat-available').textContent = availableTests;
            
            // Calculate from test history
            const historyTable = document.querySelector('.table tbody');
            if (historyTable) {
                const rows = historyTable.querySelectorAll('tr');
                const completedTests = rows.length;
                let totalScore = 0;
                let totalMarks = 0;
                
                rows.forEach(row => {
                    const scoreText = row.cells[2]?.textContent || '';
                    const match = scoreText.match(/(\d+)\/(\d+)/);
                    if (match) {
                        totalScore += parseInt(match[1]);
                        totalMarks += parseInt(match[2]);
                    }
                });
                
                document.getElementById('stat-completed').textContent = completedTests;
                document.getElementById('stat-total-marks').textContent = totalScore;
                
                const avgPercentage = totalMarks > 0 ? Math.round((totalScore / totalMarks) * 100) : 0;
                document.getElementById('stat-average').textContent = avgPercentage + '%';
            } else {
                document.getElementById('stat-completed').textContent = '0';
                document.getElementById('stat-total-marks').textContent = '0';
                document.getElementById('stat-average').textContent = '0%';
            }
        }
        
        async function loadAvailableTests() {
            const tests = await getAllTests();
            const container = document.getElementById('available-tests');
            
            if (tests.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìù</div>
                        <div class="empty-state-text">No tests available</div>
                        <div class="empty-state-subtext">Check back later for new tests</div>
                    </div>
                `;
                return;
            }
            
            const html = [];
            for (const test of tests) {
                const canStart = await canStartTest(test);
                const hasAttempted = await checkUserHasAttemptedTest(currentUser.email, test.id);
                
                const topics = test.questions && test.questions.length > 0 ? 
                    Array.from(new Set(window.testMetadata?.topics || ['Python Basics'])) : ['Python Basics'];
                
                html.push(`
                    <div class="test-card ${!canStart || hasAttempted ? 'disabled' : ''}" ${canStart && !hasAttempted ? `onclick="startTest('${test.id}')"` : ''}>
                        <h3>${test.title}</h3>
                        
                        <div style="display: flex; flex-direction: column; gap: 0.5rem; margin: 1rem 0;">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="color: var(--text-tertiary); font-size: 0.875rem;">‚è±Ô∏è Duration:</span>
                                <span style="font-weight: 600;">${test.duration} minutes</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="color: var(--text-tertiary); font-size: 0.875rem;">üìä Total Marks:</span>
                                <span style="font-weight: 600;">${test.totalMarks || 'N/A'}</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="color: var(--text-tertiary); font-size: 0.875rem;">‚ùì Questions:</span>
                                <span style="font-weight: 600;">${test.questions ? test.questions.length : 0}</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="color: var(--text-tertiary); font-size: 0.875rem;">üìÖ Available:</span>
                                <span style="font-size: 0.875rem; color: var(--text-secondary);">${test.startDate} to ${test.endDate}</span>
                            </div>
                        </div>
                        
                        <div class="test-topics">
                            ${topics.map(topic => `<span class="topic-tag">${topic}</span>`).join('')}
                        </div>
                        
                        <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border-secondary); display: flex; align-items: center; justify-content: space-between;">
                            ${hasAttempted ? 
                                '<span class="badge badge-warning">Completed</span>' :
                                canStart ? 
                                    '<button class="btn btn-primary" onclick="event.stopPropagation(); startTest(\'' + test.id + '\')">Start Test</button>' :
                                    '<span class="badge badge-neutral">Not Available</span>'
                            }
                        </div>
                    </div>
                `);
            }
            
            container.innerHTML = html.join('');
        }
        
        async function canStartTest(test) {
            const now = new Date();
            const start = new Date(test.startDate);
            const end = new Date(test.endDate);
            return now >= start && now <= end;
        }
        
        async function loadTestHistory() {
            const attempts = await getTestAttemptsByUser(currentUser.email);
            const container = document.getElementById('test-history');
            
            if (attempts.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìä</div>
                        <div class="empty-state-text">No test attempts yet</div>
                        <div class="empty-state-subtext">Your completed tests will appear here</div>
                    </div>
                `;
                return;
            }
            
            // Convert Firestore timestamps if needed
            const formattedAttempts = attempts.map(a => ({
                ...a,
                startTime: a.startTime?.toMillis ? a.startTime.toMillis() : a.startTime,
                submitTime: a.submitTime?.toMillis ? a.submitTime.toMillis() : a.submitTime
            }));
            
            container.innerHTML = `
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Test</th>
                                <th>Start Time</th>
                                <th>Submit Time</th>
                                <th>Score</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${formattedAttempts.map(attempt => {
                                const percentage = ((attempt.totalScore / attempt.maxScore) * 100).toFixed(1);
                                const statusClass = percentage >= 70 ? 'badge-success' : percentage >= 50 ? 'badge-warning' : 'badge-error';
                                return `
                                    <tr>
                                        <td style="font-weight: 600;">${attempt.testTitle}</td>
                                        <td>${new Date(attempt.startTime).toLocaleString()}</td>
                                        <td>${new Date(attempt.submitTime).toLocaleString()}</td>
                                        <td>
                                            <strong>${attempt.totalScore}/${attempt.maxScore}</strong>
                                            <span style="color: var(--text-tertiary); margin-left: 0.5rem;">(${percentage}%)</span>
                                        </td>
                                        <td>
                                            <span class="badge ${statusClass}">
                                                ${attempt.autoSubmitted ? 'Auto-Submitted' : 'Submitted'}
                                            </span>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        window.startTest = async function(testId) {
            const hasAttempted = await checkUserHasAttemptedTest(currentUser.email, testId);
            
            if (hasAttempted) {
                alert('You have already attempted this test.');
                return;
            }
            
            window.location.href = `test.html?testId=${testId}`;
        };
        
        window.logout = async function() {
            if (isDemoUser()) {
                sessionStorage.removeItem('demoUser');
            } else {
                await signOut();
            }
            sessionStorage.removeItem('currentUser');
            window.location.href = 'login.html';
        };
        
        // Initialize on load
        window.addEventListener('DOMContentLoaded', initStudentDashboard);
    </script>
</body>
</html>
